---
output: 
  html_document:
    theme: null
    css: document.css
---

```{r load, message=FALSE, echo=FALSE}
# set knitr options
source("lib_knitr.R")

# load data
load("data.rda")

# load packages and functions
library("tidyverse")
library("stringr")
library("ggrepel")
library("printr")

source("lib_plot.R")        # colour scales and theme
source("lib_data_manip.R")  # summarise tables
```

# Description of data


## Spatial scope

Fish larvae were collected at the following sites

```{r}
map + geom_point(data=sites) + geom_text_repel(aes(label=site), data=sites, size=3, segment.alpha=0.7)
```

## Temporal scope

Sampling occurred over the periods

```{r}
summary_effort <- effort %>% group_by(site) %>% summarise(begin=min(date), end=max(date, na.rm=T), n_nights_sampled=length(unique(date)), `n_CARE_fished`=sum(n_gear, na.rm=T)) %>% ungroup() %>% arrange(site)
summary_effort
```

```{r}
ggplot(effort) + geom_point(aes(x=date, y=site), shape="|") +
  scale_y_discrete(
    breaks=summary_effort$site,
    labels=str_c(summary_effort$site, " (n=", summary_effort$n_CARE_fished, ")")
  ) + theme(axis.title.x=element_blank(), axis.title.y=element_blank())
```

## Sampling effort

At each sites, CARE light traps were deployed at several stations. The number of fish caught was summed per site and divided by the number of CARE observed to be working when collected in the morning, to compensate for sampling effort. This Catch Per Unit Effort (cpue = nb fish / CARE / night / site) is the unit used in the rest of the report. Unless otherwise stated, it includes nights with 0 catches.

Statistics on the number of CARE working per night at each site are

```{r}
# effort %>% group_by(site) %>% summarise(mean=round(mean(n_gear, na.rm=T),1), median=median(n_gear, na.rm=T), min=min(n_gear, na.rm=T), max=max(n_gear, na.rm=T)) %>% ungroup() %>% arrange(site)
effort %>% group_by(site) %>% sum_tbl("n_gear") %>% select(-n, -n_NA, -starts_with("q"))
```

## Distribution of catches

We focus on *coastal fish* taxa only. A total of `r sum(d$n)` larvae were caught. The most commonly observed catch per night per CARE (CPUE), is 0, by far (the bars represent the number of times a given CPUE was observed in the dataset).

```{r}
dd <- d0 %>% filter(!is.na(family)) %>% group_by(date, site) %>% summarise(cpue=sum(cpue))
ggplot(dd) + geom_histogram(aes(x=cpue), binwidth=10)

# Compute mean CPUE
d0 %>% group_by(site, date) %>% summarize(cpue=sum(cpue)) %>% ungroup() %>% summarize(meanCPUE=mean(cpue, trim = 0), sd = sd(cpue))
# # A tibble: 1 × 2
#   meanCPUE    sd
#      <dbl> <dbl>
#  1      4.5   30

d0 %>% filter(cpue < 500) %>% group_by(site, date) %>% summarize(cpue=sum(cpue)) %>% group_by(site) %>% summarize(meanCPUE=mean(cpue, trim = 0.0), sd = sd(cpue))
# # A tibble: 13 × 3
#             site meanCPUE    sd
#           <fctr>    <dbl> <dbl>
# 1        Leucate     1.77   3.2
# 2   Port Vendres     1.50   3.1
# 3           Agde     1.60   1.7
# 4          Carry     0.81   1.4
# 5      Marseille     1.38   3.4
# 6         Cassis     7.51  13.5
# 7      La Ciotat     5.34   9.1
# 8     Les Embiez     5.98  11.9
# 9      Port-Cros     5.91  12.3
# 10  Villefranche     5.07  11.2
# 11     Bonifacio     4.07  12.0
# 12 Saint Florent    17.59  51.0
# 13        Bastia     1.08   2.3


```

Excluding 0, pooling all taxa together, and using log10 scaling to see low catches better (NB: notice the labels of the x-axis), the most commonly observed catches are still very low, often around 1 fish/CARE/night/site.

```{r}
ggplot(dd) + geom_histogram(aes(x=cpue), binwidth=0.1, na.rm=T) + scale_x_continuous(breaks=c(0, 1, 10, 100, 1000), trans="log10")
```

However, in terms of total number of fish supplied to the coast, its the rare, very high CPUE nights that contribute the most; the following plot is basically the previous one where each bar is multiplied by the number of larvae it corresponds to.

```{r}
ggplot(dd) + geom_histogram(aes(x=cpue, weight=cpue), binwidth=0.1, na.rm=T) + scale_x_continuous(breaks=c(0, 1, 10, 100, 1000), trans="log10") + labs(y="number of larvae")
```

```{r}
tot <- sum(dd$cpue)
dd <- dd %>% ungroup() %>% arrange(desc(cpue))
i50 <- min(which(cumsum(dd$cpue) >= tot*0.5))
percent50 <- round(i50 / nrow(dd) * 100)

# exclude nights with particularly high catches
dd <- dd[-c(1,2),]
tot <- sum(dd$cpue)
i50ex <- min(which(cumsum(dd$cpue) >= tot*0.5))
percent50ex <- round(i50ex / nrow(dd) * 100)

i90ex <- min(which(cumsum(dd$cpue) >= tot*0.9))
percent90ex <- round(i90ex / nrow(dd) * 100)
```

Overall, `r nrow(dd)` sampling "events" (one event = one night fished at one site) are recorded in the dataset. Over 50% of the `r sum(d$n)` larvae caught were caught during only `r i50` of those fishing events (`r percent50`% of the effort). Two nights in Corsica resulted in extremely high catches of *S smaris*, which mask everything else. Even excluding those, the `r percent50ex`% richest events represent >50% of the catch and the `r percent90ex`% richest yield >90% (almost all) the catch.

In summary, catches are often *low*, extremely *variable* (probably both geographically and in time) and what matters to coastal populations are the *few nights with high catches*, the rest is just negligible.
