---
output: 
  html_document:
    theme: null
    css: document.css
---

```{r load, message=FALSE, echo=FALSE}
# set knitr options
source("lib_knitr.R")

# load data
load("data.rda")

# load packages and functions
library("reshape")
library("plyr")
library("dplyr")
library("tidyverse")
library("FactoMineR")
library("printr")
library("stringr")
library("lubridate")
library("vegan")

library("cluster")
library("ggdendro")
library("dendextend")
library("NbClust")
library("factoextra")

source("lib_plot.R")        # colour scales and theme
source("lib_data_manip.R")  # summarise tables
source("lib_factorial.R")   # extract and plot info from CAs
source("lib_quantreg.R")
```

# Spatial distribution

## Abundances among sites

### Total community

Grouping all taxa, the catch per night is highly variable among sites, with some very extreme events yielding very high catches (NB: q25 and q75 are the quantiles at 25% and 75%, the median is the quantile at 50%; those are less sensitive than the mean to extreme values and represent the "general case" better).

```{r}
dd <- d0 %>% group_by(site, date) %>% summarise(cpue=sum(cpue))

# ggplot(dd) + geom_path(aes(x=cpue, linetype=site, color=site, y=..scaled..), stat="density", bw=0.2) + theme(legend.position=c(0.8, 0.8), legend.key.width=unit(10, "mm")) + labs(y="Scaled probability density")
# last_plot() + scale_x_continuous(trans="identity", limits=c(0,10))

dd_summary <- dd %>% sum_tbl("cpue") %>% select(-n, -n_NA)
dd_summary
```

```{r}
ggplot(dd) + geom_boxplot(aes(x=site, y=cpue)) + coord_flip()
```

```{r}
# compute median CPUE per site
cpue_per_site <- dd %>% group_by(site) %>% summarise(med=median(cpue)) %>% arrange(desc(med))
overall_med_cpue <- median(dd$cpue)
cpue_per_site$good <- cpue_per_site$med > overall_med_cpue
```

Excluding those extreme events and focusing on the more common, low (CPUE < 10), catches, allows to highlight that some sites yield better catches (`r head(cpue_per_site$site, 4)`) and other are consistently low (`r tail(cpue_per_site$site, 4)`). NB: Keeping only low catches eliminates `r nrow(filter(dd, cpue >= 10))` records from `r nrow(dd)`.

```{r fig.height=4}
ggplot(dd) + geom_boxplot(aes(x=site, y=cpue, fill=..middle..), na.rm=T) + coord_flip(ylim=c(0, 10)) + scale_fill_viridis(name="median\ncpue") + theme(legend.position="bottom")
```

Same information on a map with q75 in blue, median in green, and q25 in yellow.

```{r}
# add site coordinates
dd_summary <- left_join(dd_summary, sites, by="site")
cols <- viridis.colors(4)[-1]
map +
  geom_point(aes(x=lon, y=lat, size=q75), shape=16, data=dd_summary, colour=cols[1], alpha=0.7) +
  geom_point(aes(x=lon, y=lat, size=median), shape=16, data=dd_summary, colour=cols[2], alpha=0.7) +
  geom_point(aes(x=lon, y=lat, size=q25), shape=16, data=dd_summary, colour=cols[3], alpha=0.7) +
  scale_size_area(max_size=20, guide="none")
```

Those differences are reflected by global and pairwise statistical tests. Marseille and Bastia are different (lower catches) from most of the others.

```{r tests}
# test with Anova + Tukey
#anova <- aov(log1p(cpue)~site, data=dd)
#shapiro.test(residuals(anova))
#bartlett.test(residuals(anova)~dd$site)
# => Hypothèses non vérifiées même après transformation log

# Test with non parametric test
summary(aovq(cpue ~ site, tau=c(0.5, 0.75, 0.9), data=dd), test="anowar",R=1000)
suppressWarnings(pw <- pairwise.wilcox.test(dd$cpue, dd$site))
# plot
pw <- melt(pw$p.value)
pw$X1 <- factor(pw$X1, levels=levels(dd$site))
pw$X2 <- factor(pw$X2, levels=levels(dd$site))
pw$signif <- pw$value < 0.05
ggplot(pw) + geom_point(aes(X1, X2, shape=signif, colour=signif), na.rm=T) + theme(axis.text.x = element_text(angle=30, hjust=1), axis.title=element_blank())
```

There does not seem to be a large scale geographical pattern to this (sites are ordered from west to east)... Compare Gulf of Lyon vs Ligurian Sea

```{r}
# add regions for each site
dd <- left_join(dd, sites, by="site")

# test
summary(aovq(cpue ~ topography, tau=c(0.5, 0.75, 0.9), data=dd), test="anowar", R=1000)
ggplot(dd) + geom_boxplot(aes(x=topography, y=cpue), na.rm = TRUE) + ylim(0, 10)
```

and influence of Rhône

```{r}
# test
summary(aovq(cpue ~ region, tau=c(0.5, 0.75, 0.9)), data=dd, test="anowar", R=1000)
ggplot(dd) + geom_boxplot(aes(x=region, y=cpue), na.rm = TRUE) + ylim(0, 10)
```

*No statistical difference* can be detected between these regions (Gulf-Lion/Ligure, and West-Rhone/East-Rhone) for 50% of catches, that is for low catches.

However, concerning mid catches (0.75 <=> > 1-2 larvae / Care) and high catches (0.9 <=> > 10 larvae) there were significant differences. 

Fish larvae abundance was higher for sites located in the Ligurian Sea than those located in the Gulf of Lion, and also higher for sites of Ligurian Sea. 



### Per species

The same tests can be performed per species, to detect if a given species is caught more in the west or in the east. The following tables display the mean±SD of the CPUE for each species in each region, together with the statistic and *p*-value of a quantile anova regression test between regions. NB: *Boops boops* removed because it is not caught in the West

```{r}
# keep only abundant species, but B boops which is not caught in the West
d_abund <- filter(d0, species %in% abundant_species, species != "Boops boops")

# # remove the extreme values for S smaris
d_abund <- filter(d_abund, cpue < 200)

# add site characteristics
d_abund <- left_join(d_abund, sites, by="site")
```

```{r}
# topography
descriptive_stats <- d_abund %>%
  group_by(sp, topography) %>%
  summarise(stats=str_c(round(mean(cpue),2), "±", round(sd(cpue),1))) %>% 
  spread(key=topography, value=stats)

p_val <- d_abund %>% group_by(sp) %>% do(tidy((summary(aovq(cpue ~ topography, tau=c(0.5, 0.75, 0.9), data=dd), test="rank")$table$pvalue)))
tau_val <- d_abund %>% group_by(sp) %>% do(tidy((summary(aovq(cpue ~ topography, tau=c(0.5, 0.75, 0.9), data=dd), test="rank")$table$tau)))

res <- data.frame(tau_val, p_val)
res <- select(res, sp, tau = x, p.val = x.1)

# make a nice table with both
left_join(descriptive_stats, res, by="sp") %>% ungroup()
```

```{r}
# and the corresponding plot...
ggplot(d_abund, aes(x=sp, y=cpue, colour=topography)) + geom_boxplot(na.rm=T) + scale_y_continuous(trans="log10") + theme(axis.text.x=element_text(angle=35, hjust=1))
```

```{r}
# same for region
descriptive_stats <- d_abund %>%
  group_by(sp, region) %>%
  summarise(stats=str_c(round(mean(cpue),2), "±", round(sd(cpue),1))) %>% 
  spread(key=region, value=stats)


p_val <- d_abund %>% group_by(sp) %>% do(tidy((summary(aovq(cpue ~ region, tau=c(0.5, 0.75, 0.9), data=dd), test="rank")$table$pvalue)))
tau_val <- d_abund %>% group_by(sp) %>% do(tidy((summary(aovq(cpue ~ region, tau=c(0.5, 0.75, 0.9), data=dd), test="rank")$table$tau)))

res <- data.frame(tau_val, p_val)
res <- select(res, sp, tau = x, p.val = x.1)

# make a nice table with both
left_join(descriptive_stats, res, by="sp") %>% ungroup()
```

```{r}
# and the corresponding plot...
ggplot(d_abund, aes(x=sp, y=cpue, colour=region)) + geom_boxplot(na.rm=T) + scale_y_continuous(trans="log10") + theme(axis.text.x=element_text(angle=35, hjust=1))
```

Overall, many differences are significant when the actual data is mostly noise above 0. Very difficult to interpret.

TODO use quantiles and test the difference between sites/regions for high catches, medium catches and low catches only. investigate quantreg() with a discrete explanatory variable.

```{r}
## Quantile regression for high catches, medium catches and low catches with discrete variable : comparison between sites

p_val <- d_abund %>% group_by(sp) %>% do(tidy((summary(aovq(cpue ~ site, tau=c(0.5, 0.75, 0.9), data=dd), test="rank")$table$pvalue)))
tau_val <- d_abund %>% group_by(sp) %>% do(tidy((summary(aovq(cpue ~ site, tau=c(0.5, 0.75, 0.9), data=dd), test="rank")$table$tau)))

res <- data.frame(tau_val, p_val)
res <- select(res, sp, tau = x, p.val = x.1)

# Pour toutes les espèces, des différences entre les sites, mais quels sont les sites qui diffèrent ??
```

## Species composition among sites

### Taxonomic richness

Total number of family, genus and species catched by sampling site.

```{r fig.height=5}
dd_tax <- unique(select(d, site, family, genus, species))
dd_tax <- dd_tax[-which(dd_tax$family=="Unidentified"),]

dd_sp <- ddply(dd_tax, ~ site, summarise, nb.family = length(unique(na.omit(family))),
                          nb.genus = length(unique(na.omit(genus))),
                          nb.species = length(unique(na.omit(species))))

dd_sp <- arrange(dd_sp, nb.species)

## Number of nights 
dd <- d0 %>% group_by(site, date, n_gear) %>% summarise(cpue=sum(cpue)) %>% ungroup()
dd_night <- dd %>% group_by(site) %>% summarise(nb_night=length(unique(date)), nb_care=sum(n_gear)) %>% ungroup()
dd_sp <- left_join(dd_sp, dd_night, by=c("site"))

dd_sp
```

More species are caught in Villefranche probably because sampling is done in winter too.

Effort (nb of nights/care deployed) vs nb of species curves to see if this is just related to differing effort or if there is a true difference in diversity among sites.

1) Species-nigths accumulation curves
2) Species-care accumulation curves

```{r}
## Species-nigths accumulation curves

dd <- d0 %>% group_by(site, date, species) %>% summarise(cpue=sum(cpue)) %>% ungroup()
dd <- filter(dd, !is.na(species))

sp_acum <- function(x){
  xm <- spread(x, key="species", value="cpue", fill=0)
  sp <- specaccum(select(xm, -date, -site), method="exact")
  return(data.frame(nights=sp$sites, richness = sp$richness))
}

spd <- dd %>% group_by(site) %>% do(sp_acum(.))
ggplot(spd) + geom_line(aes(nights, richness, linetype=site, colour=site), size=1)+ theme(legend.key.width = unit(1.5, "cm"))+ theme_classic()


## Species-care accumulation curves

# Code 1
dd <- d %>% group_by(site, date, n_gear, species) %>% summarise(cpue=sum(cpue)) %>% ungroup()
dd <- filter(dd, !is.na(species))

sp_acum <- function(x){
  xm <- spread(x, key="species", value="cpue", fill=0)
  xm_care <- xm %>% group_by(site) %>% mutate(n_gear=cumsum(n_gear)) %>% ungroup()
  sp <- specaccum(select(xm_care, -date, -site, -n_gear), method="exact")
  return(data.frame(nb_care=xm_care$n_gear, richness = sp$richness))
}

spd <- dd %>% group_by(site) %>% do(sp_acum(.))
ggplot(spd) + geom_line(aes(nb_care, richness, linetype=site, colour=site), size=0.5)+ theme(legend.key.width = unit(1.5, "cm"))


# 2nd code
#dd <- d0 %>% group_by(site, date, n_gear, species) %>% summarise(cpue=sum(cpue)) %>% ungroup()
#dd <- filter(dd, !is.na(species))

#sp_acum <- function(x){
#  xm <- spread(x, key="species", value="cpue", fill=0)
#  sp <- specaccum(select(xm, -date, -site, -n_gear), method="random", w=xm$n_gear)
#  return(data.frame(nb_care=sp$effort, richness = sp$richness))
#}

#spd <- dd %>% group_by(site) %>% do(sp_acum(.))
#ggplot(spd) + geom_line(aes(nb_care, richness, linetype=site, colour=site), size=1)+ theme(legend.key.width = unit(1.5, "cm"))+ theme_classic()
```

1) Species-nigths accumulation curves :
Cassis and Carry the least diverse 
Saint Florent, Villefranche and Leucate the more diverse

2) Species-care accumulation curves : From the the most diverse site to the least diverse 
Villefranche > Saint Florent > Port-Cros > Les Embiez > Leucate > Agde et Port-Vendres > La Ciotat > Marseille > Bonifacio > Bastia > Cassis > Carry


### Site-species associations

Through a Correspondence Analysis we can study the *relative* proportions of the dominant species at each site. On the plot, sites are close to the species which were most common at this site compared to other species and other sites. So overall, the following sites are characterised by a larger proportion of the following species:

- Marseille and Villefranche: *O melanuara*, *B boops*, *D annularis*
- Bonifacio and Saint Florent: *S smaris*, *A hepsetus*
- Port-Cros, Agde, and Port-Vendres: *M surmuletus*, *P pilicornis*

For the other sites, no species is particularly characteristic.

```{r fig.height=5}
dd <- d0 %>% filter(species %in% abundant_species) %>% group_by(site, species) %>% summarise(mean=mean(cpue))
ca <- CA(as.multivar(dd, "site"), graph=F)
autoplot(ca, size=1)
```

Another way to look at this data is through hierachical clustering using the Bray-Curstis distance. This hierarchical view mostly separates an eastern group from a western group, with the exceptions of Bastia and Port-Cros.

Hierchical clustering performed on bray-curtis distance matrix, and then hierarchical clustering performed on chi2 distance (decostand + dist).

1) Hierarchical clustering on bray-curtis distance matrix
2) Hierarchical clustering on chi2 distance matrix

```{r fig.height=5}
# HAC clustering for sites based on community composition
dist_matrix <- vegdist(as.multivar(dd, "site"), "bray")
hdw <- hclust(dist_matrix, method="ward.D2")
dend <- as.dendrogram(hdw)
dend %>% set("branches_k_color", k = 5) %>% set("labels_col", k=5) %>% plot(las=1, ylab="Heigh")

# investigate using chi2 distance (decostand+dist) which should give something closer to the CA or clustering the output of the CA with euclidian distance
dd_stand <- decostand(as.multivar(dd, "site"), method = "chi.square")
dist_matrix <- vegdist(dd_stand, "euclidean")
hdw <- hclust(dist_matrix, method="ward.D2")
dend <- as.dendrogram(hdw)
dend %>% set("branches_k_color", k = 6) %>% set("labels_col", k=6) %>% plot(las=1, ylab="Heigh")
```

Try to find some criterion to cut off dendrogramm. It works only for clustering performed on decostand matrix because function fviz_nbclust can't compute bray-curtis distance. 

```{r}
# Try to Find cutoff with some criterion
fviz_nbclust(dd_stand, FUNcluster=hcut, method = c("wss"))#+geom_vline(xintercept = 5, linetype = 2)
fviz_nbclust(dd_stand, FUNcluster=hcut, method = c("silhouette"), hc_method = "ward.D2")
```

Using a one-way PERMANOVA based on Bray-Curtis distance we can explicitely test for the significance of the difference of communities between regions.

```{r}
data.env <- data.frame(as.multivar(dd, "site"), sites)
data.env <- select(data.env, site, topography, region)

adonis((as.multivar(dd, "site"))~region, data.env, permutations = 999, method="bray")$aov.tab
adonis((as.multivar(dd, "site"))~topography, data.env, permutations = 999, method="bray")$aov.tab
```

- Species assemblage was not different between site located in the ligurian sea and those located in the Gulf of Lion. 

- Species assemblage seems to be different between sites according to the region (side of the Rhone), (PerMANOVA p < 0.05). However, hierarchical clustering didn't group western sites (Port-Vendres, Agde, Leucate) together.

Except for Port-Cros, results of hierarchical clustering are more coherent with results of larval abundance, all species included (most abundant species). 



## Synchronicity among sites

### Time arrival of abundant species : Plot

```{r fig.height=8}
# mean CPUE per week, site, and species for common species
dd <- d0 %>% filter(year !=2016, species %in% abundant_species) %>% group_by(yweek, year, site, species) %>% summarise(cpue=mean(cpue))

# create a new weekly date coordinate
dd$date <- ymd(str_c(dd$year, "-01-01")) + weeks(dd$yweek)
# and a new fake one starting all the same year
dd$fake_date <- ymd("2014-01-01") + weeks(dd$yweek)

# rescale abundances per species, site and year, to get a comparable peak per year
dd <- dd %>% group_by(species, site, year) %>% mutate(scaled_cpue=cpue/max(cpue))
dd$scaled_cpue[is.na(dd$scaled_cpue)] <- 0  # when max = 0

# # remove large date jumps (i.e. add NAs at the beginning of the jump)
# dd <- arrange(dd, species, site, date) %>% ungroup()
# dd <- ddply(dd, ~species+site, function(x, large=30) {
#   large_jumps <- c(diff(x$date) > large, FALSE)
#   # repeat each line at the beginning of a large jump
#   x <- x[rep(1:nrow(x), as.numeric(large_jumps)+1),]
#   # replace the abundances at that date by NA
#   large_jumps <- c(diff(x$date) > large, FALSE)
#   x$scaled_cpue[large_jumps] <- NA
#   return(x)
# })

# rename species for display
dd$species_abbr <- abbrev_sp(dd$species, n=4)

# group sites per region
sites$region <- c(
  rep("Golfe du Lion", 3),
  rep("Marseille et environs", 4),
  rep("Var", 2),
  rep("Alpes Mar.", 1),
  rep("Corse", 3)
)

# we want to use a combination of colour and linetype to identify all sites
# ggplot2 cannot do that on its own so we need to manually compute the interaction between the two and create the appropriate scales

# prepare manual colours
colours <- scales::hue_pal(h = c(0, 360) + 15, c = 100, l = 65, h.start = 0)(length(unique(sites$region)))
sites$region_id <- as.numeric(as.factor(sites$region))
sites$colours <- colours[sites$region_id]

# prepare manual linetypes
linetypes <- c("solid", "11", "12", "21")
# linetypes <- 1:4
sites$region_change <- c(FALSE, diff(sites$region_id) != 0)
sites$linetypes <- 0
index <- 0
for (i in 1:nrow(sites)) {
  if (sites$region_change[i]) {
    index <- 1
  } else {
    index <- index + 1
  }
  sites$linetypes[i] <- index
}
sites$linetypes <- linetypes[sites$linetypes]

# compute the interaction, which will be mapped in ggplot
dd <- left_join(dd, select(sites, site, region), by="site")
dd$region_site <- interaction(dd$region, dd$site)
dd$region_site <- factor(dd$region_site, labels=sites$site)

# nice plot
ggplot(dd) +
  geom_line(aes(x=fake_date, y=scaled_cpue, colour=region_site, linetype=region_site)) +
  facet_grid(species_abbr~year)+
  scale_x_date("", date_breaks="2 month", date_labels="%b", minor_breaks=NULL) +
  theme(
    axis.text.x=element_text(angle=45, hjust=1),
    legend.position="top"
  ) +
  scale_linetype_manual("site", values=sites$linetypes) +
  scale_colour_manual("site", values=sites$colours) +
  no_y
```


### Time arrival anomaly

To investigate the time lag of larvae arrival between sites and between years, this two species were no take in count. Only the abundant and frequent species (= 10 species) were selected.  

```{r}
# mean CPUE per week, site, and species for common species
dd <- d0 %>% filter(year !=2016, species %in% abundant_species) %>% group_by(date, yweek, yday, year, site, species) %>% summarise(cpue=mean(cpue)) %>% ungroup()

# rescale abundances per species, site and year, to get a comparable peak per year
dd <- dd %>% group_by(species, site, year) %>% mutate(scaled_cpue=cpue/max(cpue))
dd$scaled_cpue[is.na(dd$scaled_cpue)] <- 0  # when max = 0
dd <- dd %>% arrange(species, year, site)
dd <- filter(dd, cpue!=0)


## Beginning of the season for winter species
winter <- rbind(dd[which(dd$species=="Sarpa salpa"),],dd[which(dd$species=="Pagellus acarne"),],
                dd[which(dd$species=="Pagellus bogaraveo"),])

winter$fake_date <- "2012-10-01"

winter$shift_day <- round(as.double(difftime(strptime(winter$date, format = "%Y-%m-%d"),strptime(winter$fake_date, format = "%Y-%m-%d"),units="days")),0)
winter$shift_week <- round(as.double(difftime(strptime(winter$date, format = "%Y-%m-%d"),strptime(winter$fake_date, format = "%Y-%m-%d"),units="weeks")),0)

winter$season <- "2012-2013"
winter$season[which(winter$shift_day>365 & winter$shift_day<731)] <- "2013-2014"
winter$season[which(winter$shift_day>=731 & winter$shift_day<1096)] <- "2014-2015"
winter$season[which(winter$shift_day>=1096)] <- "2015-2016"

winter$shift_day <- winter$shift_day%%365
winter$shift_week <- winter$shift_week%%52

##Check the mean arrival by season
mean <- winter %>% group_by(season, species) %>% summarise(day=mean(shift_day), week=mean(shift_week))%>%ungroup()


## So if we remove the season 2015-2016 (because of not data in begging 2016) we could be
## compare years MAYBE ???. We can consider 2012-2013 = 2012, 2013-2014 = 2013, 2014-2015 = 2014
winter$fake_year <- NA
winter$fake_year[which(winter$season=="2012-2013")] <- "2013"
winter$fake_year[which(winter$season=="2013-2014")] <- "2014"
winter$fake_year[which(winter$season=="2014-2015")] <- "2015"
winter <- winter %>% filter(!is.na(fake_year)) %>% ungroup()

syn_winter <- winter %>% group_by(fake_year, species) %>% summarise(ref_day=mean(shift_day), ref_week=mean(shift_week)) %>% ungroup()


## We have several day of arrival for each site (1256 observation in total, 1244 without end 2015) 
## and we want to compute the lag time between
## each sample with the ref time of the year, in order to plot anomalies 

## Create 2 data.frame with fake date for winter species, one for ref_time and other 
## for sample
syn_winter <- select(syn_winter,  year=fake_year, species, ref_day, ref_week)
winter <- select(winter, year=fake_year, species, site, yday=shift_day, yweek=shift_week)

##Summer species
summer <- dd[-which(dd$species=="Sarpa salpa"),] 
summer <- summer[-which(summer$species=="Pagellus acarne"),] 
summer <- summer[-which(summer$species=="Pagellus bogaraveo"),] 
summer <- select(summer, year, species, site, yday, yweek)
syn_summer <- summer %>% group_by(year, species) %>% summarise(ref_day = mean(yday), ref_week=mean(yweek))%>%ungroup() 


## All sites included, mean arrival of larvae by species(winter species + summer species) 
## by year was : 
syn_year <- rbind(syn_summer, syn_winter)
samples <- rbind(as.data.frame(summer), as.data.frame(winter))


### Compute time lag between site (by samples) for each year and each species
lag <- left_join(syn_year,samples, by = c("year","species"))
lag <- lag %>% group_by(species,year,site, ref_day, ref_week, yday, yweek) %>% summarise(lag_day = yday-ref_day, lag_week = round(yweek-ref_week))%>%ungroup()
lag <- lag %>% arrange(species,year, lag_week)

# Plot and mean lag for sites 
lag <- lag[-which(lag$species=="Boops boops"),]
lag <- lag[-which(lag$species=="Oblada melanura"),]
res_site <- lag %>% group_by(site) %>% summarise(mean = mean(lag_week), median=median(lag_week))
```

Anomaly of larvae arrival (in week) between sites

- Trends in time arrival seem to be different between sites. The first sites to recruit are Bastia, Saint-Florent, Bonifacio and Villefranche. This sites are some weeks in front of the mean date of larvae arrival. 
- Then Port-Cros, Les Embiez, La Ciotat and Cassis recruits in the same period
- Finally Marseille, Agde, Port-Vendres and Leucate recruite are the lastest site to recruit. (Carry is in front of but only 3 species, S.maris, C.chromis and D.annularis wich recruit early in year)

These differences could be due to a difference in sampling effort ?? Some sites which recruits earlier could be result of sampling only year for which time arrival of larvae was earlier than years of sampling of the other sites. 
However, there is no difference recorded between years ...
So differences between sites maybe due to the species catched in each site ?? 

```{r fig.height=7}
ggplot(lag) +
  geom_histogram(aes(x=lag_week),binwidth=1) +
  geom_density(aes(x=lag_week, y=..count..)) +
  facet_wrap(~site, ncol=3)+geom_vline(xintercept = 0,linetype="dashed") + xlab("")
```

Test if arrival anomaly (unit of lag_time = week) of each site is relevant with one sample wilcox.test. 

```{r}
descriptive_stats <- lag %>%
  group_by(site) %>%
  summarise(stats=str_c(round(mean(lag_week),2), "±", round(sd(lag_week),1)), median=median(lag_week)) 

suppressWarnings (test <- lag %>% group_by(site) %>% do(glance(wilcox.test(.$lag_week,mu = 0,alternative = "two.sided"))))

# make a nice table with both
left_join(descriptive_stats, select(test, statistic, p.value), by="site") %>% ungroup()
```

### Understand anomaly between sites 

Abundance distribution of species by site, to understand if time arrival anomaly between site is due to the species catched or realy by a lag time between sites. 

```{r}
dd_test <- select(d0, site, species, cpue)
dd_test <- dd_test %>% filter(!is.na(species))
# head_sp <- select(dd_stat, family, species)
# dd_test <- left_join(head_sp, dd_test, by="species")
dd_test <- filter(dd_test, species %in% abundant_species)
dd_test$species <- abbrev_sp(dd_test$species, n=4)
```

```{r fig.height=8, fig.width=6}
ggplot(dd_test, aes(x=species, y=cpue)) + geom_boxplot() + scale_y_continuous(trans="log10") + facet_wrap(~site, ncol=2) + theme(axis.text.x=element_text(angle=25, hjust=1)) + ylab("log(cpue)")
```


```{r}
# Summary on arrival by species after corrected date for winter species

## Mean arrival day and week by species (all years and sites included) with date corrected
## for winter species

syn <- samples %>% group_by(species) %>% summarise(ref_day = mean(yday), ref_week=mean(yweek), first_quart = quantile(yweek,0.25), third_quart = quantile(yweek,0.75)) %>% ungroup()

# as.data.frame(syn)
```



## Synchronicity among years : Anomaly

Anomaly of larvae arrival (in week) between years

```{r}
# Plot and mean lag
res_year <- lag %>% group_by(year) %>% summarise(mean = mean(lag_week), median = median(lag_week))
```

All sites and species included, no difference was observed between years in time arrival of larvae. However, for some species, B.Boops, S.smaris, D.annularis, O.melanura, M.surmuletus, temporal plot (cf 4.temporal Rmd) show that 2014 is in front of the other years. 


```{r fig.height=4}
ggplot(lag) +
  geom_histogram(aes(x=lag_week),binwidth=1) +
  geom_density(aes(x=lag_week, y=..count..)) +
  facet_wrap(~year, ncol=3)+geom_vline(xintercept = 0,linetype="dashed") + xlab("")
```

Test time arrival anomaly between years 

```{r}
descriptive_stats <- lag %>%
  group_by(year) %>%
  summarise(stats=str_c(round(mean(lag_week),2), "±", round(sd(lag_week),1)), median=median(lag_week)) 

suppressWarnings (test <- lag %>% group_by(year) %>% do(glance(wilcox.test(.$lag_week,mu = 0,alternative = "two.sided"))))

# make a nice table with both
left_join(descriptive_stats, select(test, statistic, p.value), by="year") %>% ungroup()
```

All species included (the most abundant species), there is no significant difference in time arrival of larvae between the four years.

2012 = only species which recruit in summer
2013 = winter species (season 2012-2013) + summer species of 2013
2014 = winter species (season 2013-2014) + summer species of 2014
2015 = winter species (season 2015-2016) + summer species of 2015


