---
output: 
  html_document:
    theme: null
    css: document.css
---

```{r load, message=FALSE, echo=FALSE}
# set knitr options
source("lib_knitr.R")

# load data
load("data.rda")

# load packages and functions
library("reshape")
library("plyr")
library("dplyr")
library("tidyverse")
library("FactoMineR")
library("printr")
library("stringr")
library("lubridate")
library("vegan")

library("cluster")
library("ggdendro")
library("dendextend")
library("NbClust")
library("factoextra")

source("lib_plot.R")        # colour scales and theme
source("lib_data_manip.R")  # summarise tables
source("lib_factorial.R")   # extract and plot info from CAs
source("lib_quantreg.R")
```

# Spatial distribution

## Abundances among sites

### Total community

Grouping all taxa, the catch per night is highly variable among sites, with some very extreme events yielding very high catches (NB: q25 and q75 are the quantiles at 25% and 75%, the median is the quantile at 50%; those are less sensitive than the mean to extreme values and represent the "general case" better).

```{r summary_table}
dd <- d0 %>% group_by(site, date) %>% summarise(cpue=sum(cpue))

# ggplot(dd) + geom_path(aes(x=cpue, linetype=site, color=site, y=..scaled..), stat="density", bw=0.2) + theme(legend.position=c(0.8, 0.8), legend.key.width=unit(10, "mm")) + labs(y="Scaled probability density")
# last_plot() + scale_x_continuous(trans="identity", limits=c(0,10))

dd_summary <- dd %>% sum_tbl("cpue") %>% select(-n, -n_NA)
dd_summary
```

```{r boxplot}
ggplot(dd) + geom_boxplot(aes(x=site, y=cpue)) + coord_flip()
```

```{r order}
# sort in decreasing order of catches to display stats, below
dd_summary <- arrange(dd_summary, desc(median))
```

Excluding extreme events and focusing on the more common, low (CPUE < 10), catches, allows to highlight that some sites yield better catches (`r head(dd_summary$site, 3)`) and other are consistently low (`r tail(dd_summary$site, 3)`). NB: Keeping only CPUE < 10 only eliminates `r nrow(filter(dd, cpue >= 10))` records out of `r nrow(dd)`. The black squares are quantile=0.9.

```{r zoomed_boxplot, fig.height=4}
# ggplot(dd) + geom_boxplot(aes(x=site, y=cpue, fill=..middle..), na.rm=T) + coord_flip(ylim=c(0, 10)) + scale_fill_viridis(name="median\ncpue") + theme(legend.position="bottom")
ggplot(ungroup(dd)) + geom_boxplot(aes(x=site, y=cpue), na.rm=T, outlier.size=1) + geom_quantiled(mapping=aes(x=dd$site, y=dd$cpue), quantiles=0.9, colour="black", size=2) + coord_flip(ylim=c(0, 10))
```

```{r map}
# Same information on a map with q75 in blue, median in green, and q25 in yellow.
# # add site coordinates
# dd_summary <- left_join(dd_summary, sites, by="site")
# cols <- viridis.colors(4)[-1]
# map +
#   geom_point(aes(x=lon, y=lat, size=q75), shape=16, data=dd_summary, colour=cols[1], alpha=0.7) +
#   geom_point(aes(x=lon, y=lat, size=median), shape=16, data=dd_summary, colour=cols[2], alpha=0.7) +
#   geom_point(aes(x=lon, y=lat, size=q25), shape=16, data=dd_summary, colour=cols[3], alpha=0.7) +
#   scale_size_area(max_size=20, guide="none")
```

When tested globally through a quantile based ANOVA, the lower quantiles are surprisingly the most different. The higher quantiles (which look very different) may be more difficult to test.


```{r tests_among_sites, echo=FALSE, }
aovq(cpue ~ site, tau=c(0.25, 0.5, 0.75, 0.9), data=dd, R=1000)

pwa <- suppressMessages(pairwise.aovq(dd$cpue, dd$site, tau=c(0.25, 0.5, 0.75, 0.9), R=1000))
pww <- suppressWarnings(pairwise.wilcox.test(dd$cpue, dd$site, p.adjust.method="holm"))
pwa$wilcox <- pww$p.value
```

In terms of pairwise differences:

- q=0.25: Saint-Florent is different, higher than others
- q=0.5: Marseille and Bastia are lower
- wilcox: Marseille and Bastia are lower, Port-Cros and St-Florent are higher; Carry is often barely signif and would be similar to Marseille.
- q=0.75: ?
- q=0.9: Villefranche is higher than others; probably because it is more eaily estimated (more effort).

```{r plot_among_sites, fig.height=7}
# plot
pw <- ldply(pwa, function(x) {
  x <- na.omit(melt(x))
  x2 <- x
  names(x2) <- c("X2", "X1", "value")
  x <- suppressWarnings(bind_rows(x, x2))
  x$X1 <- factor(x$X1, levels=levels(dd$site))
  x$X2 <- factor(x$X2, levels=levels(dd$site))
  x$signif <- x$value < 0.05
  return(x)
})
ggplot(pw, aes(X1, X2)) +
  geom_point(aes(colour=value), na.rm=T, size=5, shape=15) +
  geom_point(colour="red", na.rm=T, size=5, shape=22, data=filter(pw, signif)) +
  facet_wrap(~.id, ncol=2) + coord_fixed() +
  scale_colour_distiller("p", palette="YlGnBu", direction=1) +
  theme(
    legend.position=c(0.75, 0.15), legend.direction="horizontal",
    axis.text.x=element_blank(), axis.ticks.x=element_blank(),axis.title=element_blank()
  )
```

Overall, it seems Bonifacio, Cassis, and Carry are difficult to evaluate (low sampling effort); Bastia, Marseille, Agde, Port-Vendres, and Leucate yield low catches; Saint-Florent, Villefranche, Port-Cros, Les Embiez, La Ciotat yiled high catches.

Test whether these differences are linked with geomorphological regions:

1. Gulf of Lyon (Port-Vendres -> La Ciotat) vs Ligurian Sea (Les Embiez -> Corsica) 2. East and West of Rhône (but only 3 sites West of Rhône).

These regions are only different regarding high and extreme catches. Fish larvae abundance was higher for sites located in the Ligurian Sea than those located in the Gulf of Lions, and also higher for sites East of Rhône.

```{r abund_per_region}
# add regions for each site
dd <- left_join(dd, sites, by="site")

# test GoL vs Lig
aovq(cpue ~ topography, tau=c(0.25, 0.5, 0.75, 0.9), data=dd)
ggplot(dd) + geom_boxplot(aes(x=topography, y=cpue), na.rm = TRUE) + ylim(0, 10)

# test Rhône
aovq(cpue ~ region, tau=c(0.25, 0.5, 0.75, 0.9), data=dd)
ggplot(dd) + geom_boxplot(aes(x=region, y=cpue), na.rm = TRUE) + ylim(0, 10)
```

### Per species

The same tests can be performed per species, to detect if a given species is caught more in the West or in the East. The test was restricted to the most abundant species which are present in both locations. The following table display the mean±SD of the CPUE for each species in each region, together with the statistic and *p*-value of a quantile-based ANOVA between regions.

NB: Test done through rank procedure since bootstrap through anowar does not converge here (=sometimes low sample size, which would make any test problematic).

```{r}
# keep only abundant species, but B boops which is not caught in the West
d_abund <- filter(d0, species %in% abundant_species)

# # remove the extreme values for S smaris
d_abund <- filter(d_abund, cpue < 200)

# add site characteristics
d_abund <- left_join(d_abund, sites, by="site")
```

```{r}
# topography
descriptive_stats <- d_abund %>%
  group_by(sp, topography) %>%
  summarise(stats=str_c(round(mean(cpue),2), "±", round(sd(cpue),1))) %>% 
  spread(key=topography, value=stats)
# perform test per species
tests <- d_abund %>% group_by(sp) %>% do(aovq(cpue ~ topography, tau=c(0.25, 0.5, 0.75, 0.9), data=., test="rank")$table[,c("tau", "pvalue")]) %>% spread(key=tau, value=pvalue)

# make a nice table with both
left_join(descriptive_stats, tests, by="sp") %>% ungroup()
```

```{r}
# and the corresponding plot...
ggplot(d_abund, aes(x=sp, y=cpue, colour=topography)) + geom_boxplot(na.rm=T) + scale_y_continuous(trans="log10") + theme(axis.text.x=element_text(angle=35, hjust=1))
```

```{r}
# same for region
descriptive_stats <- d_abund %>%
  group_by(sp, region) %>%
  summarise(stats=str_c(round(mean(cpue),2), "±", round(sd(cpue),1))) %>% 
  spread(key=region, value=stats)
# perform test per species
tests <- d_abund %>% group_by(sp) %>% do(aovq(cpue ~ region, tau=c(0.25, 0.5, 0.75, 0.9), data=., test="rank")$table[,c("tau", "pvalue")]) %>% spread(key=tau, value=pvalue)

# make a nice table with both
left_join(descriptive_stats, tests, by="sp") %>% ungroup()
```

```{r}
# and the corresponding plot...
ggplot(d_abund, aes(x=sp, y=cpue, colour=region)) + geom_boxplot(na.rm=T) + scale_y_continuous(trans="log10") + theme(axis.text.x=element_text(angle=35, hjust=1))
```

Overall, many differences are significant when the actual data is mostly noise above 0. Very difficult to interpret.


## Species composition among sites

### Taxonomic richness

Total number of family, genera, and species caught by sampling site.

```{r table_richness, fig.height=5}
dd_sp <- d %>%
  filter(family!="Unidentified") %>%
  group_by(site) %>%
  summarise(
    nb.family = length(unique(na.omit(family))),
    nb.genus = length(unique(na.omit(genus))),
    nb.species = length(unique(na.omit(species)))
  )
dd_sp <- arrange(dd_sp, nb.species)

# add info on effort: number of nights and of CAREs
dd <- d0 %>% group_by(site, date, n_gear) %>% summarise(cpue=sum(cpue)) %>% ungroup()
dd_night <- dd %>% group_by(site) %>% summarise(nb_night=length(unique(date)), nb_care=sum(n_gear)) %>% ungroup()
dd_sp <- left_join(dd_sp, dd_night, by=c("site"))

dd_sp
```

More species are caught in Villefranche probably because sampling is done in winter too.

Species richness vs effort (nb of nights fishes or nb of CARE deployed) cuves are useful to know if this is just related to differing effort or if there is a true difference in diversity among sites. Here, the curves take a long time to saturate (>150 nights) and never really do. 

```{r specaccum, fig.height=4}
dd <- d0 %>% group_by(site, date, species) %>% summarise(cpue=sum(cpue)) %>% ungroup()
# cleanup data
dd <- filter(dd, !is.na(species))
dd <- arrange(dd, site, date)

# convert into species matrix
dw <- spread(dd, key="species", value="cpue", fill=0)

# add effort in terms of nb of CAREs (to weight by effort)
dw <- left_join(dw, effort, by=c("site", "date"))

# Species accumulation curves with CI
#
# @param see specaccum
accum_stats <- function(comm, permutations=1000, ...) {
  sp <- specaccum(comm, method="random", permutations=permutations, ...)
  stats <- adply(sp$perm, 1, function(x) {
    data.frame(
      richness=mean(x),
      sd=sd(x),
      ci.low=quantile(x, 0.025, names=FALSE),
      ci.high=quantile(x, 0.975, names=FALSE)
    )
  }, .id="effort")
  if (is.null(sp$effort)) {
    stats$effort <- sp$sites
  } else {
    stats$effort <- sp$effort
  }
  
  return(stats)
}

# compute per night
sp_per_night <- dw %>% group_by(site) %>% do(accum_stats(select(., -site, -date, -n_gear))) %>% rename(nights=effort)
# and per CARE
# sp_per_care <- dw %>% group_by(site) %>% do(accum_stats(select(., -site, -date, -n_gear), w=.$n_gear)) %>% rename(`Nb CARE`=effort)

# and some plots
# ggplot(sp_per_night) + geom_ribbon(aes(x=nights, ymin=ci.low, ymax=ci.high, fill=site), alpha=0.2) + geom_path(aes(x=nights, y=richness, colour=site, linetype=site)) + theme(legend.key.width = unit(1.4, "cm"), legend.position="bottom")
ggplot(sp_per_night) + geom_ribbon(aes(x=nights, ymin=richness-sd, ymax=richness+sd, fill=site), alpha=0.2) + geom_path(aes(x=nights, y=richness, colour=site, linetype=site)) + theme(legend.key.width = unit(1.4, "cm"), legend.position="bottom")

# ggplot(sp_per_care) + geom_ribbon(aes(x=`Nb CARE`, ymin=ci.low, ymax=ci.high, fill=site), alpha=0.2) + geom_path(aes(x=`Nb CARE`, y=richness, colour=site, linetype=site)) + theme(legend.key.width = unit(1.4, "cm"), legend.position="bottom")
# ggplot(sp_per_care) + geom_ribbon(aes(x=`Nb CARE`, ymin=richness-sd, ymax=richness+sd, fill=site), alpha=0.2) + geom_path(aes(x=`Nb CARE`, y=richness, colour=site, linetype=site)) + theme(legend.key.width = unit(1.4, "cm"), legend.position="bottom")
```

```{r compare_specaccum}

# Test difference in species accumulation curves among groups at a given effort level
#
# @param comm community matrix
# @param g factor giving the group for the corresponding element of comm
# @param effort effort level(s) at which to test
# @nperm number of permutations for the test
# @p.adjust.method see p.adjust
pairwise.specaccum.test <- function(comm, g, effort=c(10, 20, 30, 40, 100), nperm=1000, p.adjust.method="holm") {
  # force grouping variable (site here) to te a factor (to keep levels consistent)
  g <- as.factor(g)
  ng <- nlevels(g)
  
  # extract richness at given efforts
  richness <- function(x, e) {
    sp <- specaccum(x, method="exact")
    sp$richness[e]
  }

  # reference (i.e. observed) richness values at these levels of effort
  cs <- split(comm, g)
  rich_ref <- laply(cs, richness, e=effort)

  # nperm permutations of sites
  rich_perm <- laply(1:nperm, function(n) {
    cs <- split(comm, sample(g))
    laply(cs, richness, e=effort)
  }, .progress="none")

  # make pairwise tests manually
  # compute all i,j under the diagonal
  ij <- expand.grid(i=1:ng, j=1:ng)
  ij <- filter(ij, i > j)
  # define a function that performs the test for a given couple of i,j indexes (i.e. couple of sites)
  testij <- function(ij) {
    i <- ij[1]
    j <- ij[2]
    # reference difference between sites
    diff_ref <- abs(diff(rich_ref[c(i,j),]))
    # permutation-based distribution of differences between sites
    diff_perm <- aaply(rich_perm[,c(i,j),], 1, function(x) {abs(diff(x))})
    # compute p-value: proportion of time in which differences obtained at random are higher than what is observed
    diffs <- rbind(diff_ref, diff_perm)
    p <- apply(diffs, 2, function(x) {sum(x[-1]>x[1])/(length(x)-1)})
    return(p)
  }
  p <- apply(ij, 1, testij)
  
  # adjust and put those p.values in a easy to display matrix
  # prepare storage
  mat <- matrix(NA, nrow=ng, ncol=ng)
  dimnames(mat) <- list(levels(g), levels(g))
  # store
  pl <- alply(p, 1, function(pp) {
    pp <- p.adjust(pp, method=p.adjust.method, n=sum(!is.na(pp)))
    # NB: removes the NAs in the adjustment method
    mat[as.matrix(ij)] <- pp
    # remove all NA lines and columns
    allNA <- function(x) {all(is.na(x))}
    mat <- mat[!apply(mat, 1, allNA), !apply(mat, 2, allNA)]
    return(mat)
  })
  names(pl) <- effort

  return(pl)
}

pairwise.specaccum.test(select(dw, -date, -site, -n_gear), dw$site)
```


1) Species-nigths accumulation curves :
Cassis and Carry the least diverse 
Saint Florent, Villefranche and Leucate the more diverse

2) Species-care accumulation curves : From the the most diverse site to the least diverse 
Villefranche > Saint Florent > Port-Cros > Les Embiez > Leucate > Agde et Port-Vendres > La Ciotat > Marseille > Bonifacio > Bastia > Cassis > Carry


### Site-species associations

Through a Correspondence Analysis we can study the *relative* proportions of the dominant species at each site. On the plot, sites are close to the species which were most common at this site compared to other species and other sites. So overall, the following sites are characterised by a larger proportion of the following species:

- Marseille and Villefranche: *O melanuara*, *B boops*, *D annularis*
- Bonifacio and Saint Florent: *S smaris*, *A hepsetus*
- Port-Cros, Agde, and Port-Vendres: *M surmuletus*, *P pilicornis*

For the other sites, no species is particularly characteristic.

```{r fig.height=5}
dd <- d0 %>% filter(species %in% abundant_species) %>% group_by(site, species) %>% summarise(mean=mean(cpue))
ca <- CA(as.multivar(dd, "site"), graph=F)

dd_stand <- decostand(as.multivar(dd, "site"), method = "chi.square")
dist_matrix <- vegdist(dd_stand, "euclidean")
hdw <- hclust(dist_matrix, method="ward.D2")
part <- data.frame(group = cutree(hdw, k=6))
part$label <- rownames(part)

# Correspondance analysis for the two first dim
dat <- augment(ca)
dat <- left_join(dat, part, by = c("label"))
dat$group[which(is.na(dat$group))]<-"col"
  eig <- tidy(ca)
  dims <- names(dat)[str_detect(names(dat), "Dim")]
  labs <- str_c(dims, " (",round(eig$prop.variance[1:2]*100),"%)")
  ggplot(dat, aes_string(x=dims[1], y=dims[2], colour="group")) + scale_colour_discrete(guide="none") + geom_point(size=1) + ggrepel::geom_text_repel(aes(label=label), size=1*2.5, segment.alpha=0.7) + scale_x_continuous(breaks=0) + scale_y_continuous(breaks=0) + coord_fixed() + labs(x=labs[1], y=labs[2])
```

```{r fig.height=5}
#Correspondance analysis for dim 3 and 4
dat <- augment(ca)
dat <- left_join(dat, part, by = c("label"))
dat$group[which(is.na(dat$group))]<-"col"
  eig <- tidy(ca)
  dims <- names(dat)[str_detect(names(dat), "Dim")]
  labs <- str_c(dims, " (",round(eig$prop.variance[3:4]*100),"%)")
  ggplot(dat, aes_string(x=dims[3], y=dims[4], colour="group")) + scale_colour_discrete(guide="none") + geom_point(size=1) + ggrepel::geom_text_repel(aes(label=label), size=1*2.5, segment.alpha=0.7) + scale_x_continuous(breaks=0) + scale_y_continuous(breaks=0) + coord_fixed() + labs(x=labs[3], y=labs[4])

  
# a <- augment(ca, dimensions=c(1,2,4))
# a$col <- c("blue", "red")[as.integer(as.factor(a$type))]
# plot3d(a$Dim1, a$Dim2, a$Dim4, col=a$col)
# text3d(a$Dim1, a$Dim2, a$Dim4, texts=a$label, col=a$col)
```

Another way to look at this data is through hierachical clustering using the Bray-Curstis distance. This hierarchical view mostly separates an eastern group from a western group, with the exceptions of Bastia and Port-Cros.

Hierchical clustering performed on bray-curtis distance matrix, and then hierarchical clustering performed on chi2 distance (decostand + dist).

1) Hierarchical clustering on bray-curtis distance matrix
2) Hierarchical clustering on chi2 distance matrix

```{r fig.height=5}
# HAC clustering for sites based on community composition
dist_matrix <- vegdist(as.multivar(dd, "site"), "bray")
hdw <- hclust(dist_matrix, method="ward.D2")
dend <- as.dendrogram(hdw)
dend %>% set("branches_k_color", k = 5) %>% set("labels_col", k=5) %>% plot(las=1, ylab="Heigh")

# investigate using chi2 distance (decostand+dist) which should give something closer to the CA or clustering the output of the CA with euclidian distance
dd_stand <- decostand(as.multivar(dd, "site"), method = "chi.square")
dist_matrix <- vegdist(dd_stand, "euclidean")
hdw <- hclust(dist_matrix, method="ward.D2")
part <- data.frame(group = cutree(hdw, k=6))
part$label <- rownames(part)
dend <- as.dendrogram(hdw)
dend %>% set("branches_k_color", k = 6) %>% set("labels_col", k=6) %>% plot(las=1, ylab="Heigh")
```

Try to find some criterion to cut off dendrogramm. It works only for clustering performed on decostand matrix because function fviz_nbclust can't compute bray-curtis distance. 

```{r}
# Try to Find cutoff with some criterion
fviz_nbclust(dd_stand, FUNcluster=hcut, method = c("wss"))#+geom_vline(xintercept = 5, linetype = 2)
fviz_nbclust(dd_stand, FUNcluster=hcut, method = c("silhouette"), hc_method = "ward.D2")
```

Using a one-way PERMANOVA based on Chi-2 distance we can explicitely test for the significance of the difference of communities between regions.

```{r}
data.env <- data.frame(as.multivar(dd, "site"), sites)
data.env <- select(data.env, site, topography, region)

adonis((decostand(as.multivar(dd, "site"), method = "chi.square"))~region, data.env, permutations = 999, method="euclidean")$aov.tab
adonis((decostand(as.multivar(dd, "site"), method = "chi.square"))~topography, data.env, permutations = 999, method="euclidean")$aov.tab
```

- Species assemblage was not different between site located in the ligurian sea and those located in the Gulf of Lion. 

- Species assemblage seems to be different between sites according to the region (side of the Rhone), (PerMANOVA p < 0.05). However, hierarchical clustering didn't group western sites (Port-Vendres, Agde, Leucate) together.

Except for Port-Cros, results of hierarchical clustering are more coherent with results of larval abundance, all species included (most abundant species). 



## Synchronicity among sites

### Time arrival of abundant species : Plot

```{r fig.height=8}
# mean CPUE per week, site, and species for common species
dd <- d0 %>% filter(year !=2016, species %in% abundant_species) %>% group_by(yweek, year, site, species) %>% summarise(cpue=mean(cpue))

# create a new weekly date coordinate
dd$date <- ymd(str_c(dd$year, "-01-01")) + weeks(dd$yweek)
# and a new fake one starting all the same year
dd$fake_date <- ymd("2014-01-01") + weeks(dd$yweek)

# rescale abundances per species, site and year, to get a comparable peak per year
dd <- dd %>% group_by(species, site, year) %>% mutate(scaled_cpue=cpue/max(cpue))
dd$scaled_cpue[is.na(dd$scaled_cpue)] <- 0  # when max = 0

# # remove large date jumps (i.e. add NAs at the beginning of the jump)
# dd <- arrange(dd, species, site, date) %>% ungroup()
# dd <- ddply(dd, ~species+site, function(x, large=30) {
#   large_jumps <- c(diff(x$date) > large, FALSE)
#   # repeat each line at the beginning of a large jump
#   x <- x[rep(1:nrow(x), as.numeric(large_jumps)+1),]
#   # replace the abundances at that date by NA
#   large_jumps <- c(diff(x$date) > large, FALSE)
#   x$scaled_cpue[large_jumps] <- NA
#   return(x)
# })

# rename species for display
dd$species_abbr <- abbrev_sp(dd$species, n=4)

# group sites per region
sites$region <- c(
  rep("Golfe du Lion", 3),
  rep("Marseille et environs", 4),
  rep("Var", 2),
  rep("Alpes Mar.", 1),
  rep("Corse", 3)
)

# we want to use a combination of colour and linetype to identify all sites
# ggplot2 cannot do that on its own so we need to manually compute the interaction between the two and create the appropriate scales

# prepare manual colours
colours <- scales::hue_pal(h = c(0, 360) + 15, c = 100, l = 65, h.start = 0)(length(unique(sites$region)))
sites$region_id <- as.numeric(as.factor(sites$region))
sites$colours <- colours[sites$region_id]

# prepare manual linetypes
linetypes <- c("solid", "11", "12", "21")
# linetypes <- 1:4
sites$region_change <- c(FALSE, diff(sites$region_id) != 0)
sites$linetypes <- 0
index <- 0
for (i in 1:nrow(sites)) {
  if (sites$region_change[i]) {
    index <- 1
  } else {
    index <- index + 1
  }
  sites$linetypes[i] <- index
}
sites$linetypes <- linetypes[sites$linetypes]

# compute the interaction, which will be mapped in ggplot
dd <- left_join(dd, select(sites, site, region), by="site")
dd$region_site <- interaction(dd$region, dd$site)
dd$region_site <- factor(dd$region_site, labels=sites$site)

# nice plot
ggplot(dd) +
  geom_line(aes(x=fake_date, y=scaled_cpue, colour=region_site, linetype=region_site)) +
  facet_grid(species_abbr~year)+
  scale_x_date("", date_breaks="2 month", date_labels="%b", minor_breaks=NULL) +
  theme(
    axis.text.x=element_text(angle=45, hjust=1),
    legend.position="top"
  ) +
  scale_linetype_manual("site", values=sites$linetypes) +
  scale_colour_manual("site", values=sites$colours) +
  no_y
```


### Time arrival anomaly

To investigate the time lag of larvae arrival between sites and between years, this two species were no take in count. Only the abundant and frequent species (= 10 species) were selected.  

```{r}
library(isotone)

## Remove year 2016 and select species 
d0$n <- d0$n_gear*d0$cpue
dd <- d0 %>% filter(year !=2016, species %in% abundant_species) %>% group_by(date, yweek, yday, year, site, species) %>% summarise(cpue=sum(cpue)) %>% ungroup()


dd <- filter(dd, cpue!=0)

## Check time of arrival by species to identify winter species
ggplot(dd) +
  geom_histogram(aes(x=yweek),binwidth=1) +
  #geom_histogram(aes(x=yweek, weight=cpue),binwidth=1) +
  geom_density(aes(x=yweek, y=..count..)) +
  facet_wrap(~species, ncol=3)+geom_vline(xintercept = 0,linetype="dashed") + xlab("")

```

```{r}
#-----------

## Select winter species and choice a date to start the larvae arrival period
#winter <- rbind(dd[which(dd$species=="Sarpa salpa"),], dd[which(dd$species=="Pagellus acarne"),], dd[which(dd$species=="Pagellus bogaraveo"),])
winter <- rbind(dd[which(dd$species=="Sarpa salpa"),], dd[which(dd$species=="Pagellus acarne"),])

winter$fake_date <- "2012-10-01"


##Modify day and week according to this new date

winter$shift_day <- round(as.double(difftime(strptime(winter$date, format = "%Y-%m-%d"),strptime(winter$fake_date, format = "%Y-%m-%d"),units="days")),0)
winter$shift_week <- round(as.double(difftime(strptime(winter$date, format = "%Y-%m-%d"),strptime(winter$fake_date, format = "%Y-%m-%d"),units="weeks")),0)

winter$season <- "2012-2013"
winter$season[which(winter$shift_day>365 & winter$shift_day<731)] <- "2013-2014"
winter$season[which(winter$shift_day>=731 & winter$shift_day<1096)] <- "2014-2015"
winter$season[which(winter$shift_day>=1096)] <- "2015-2016"

winter$shift_day <- winter$shift_day%%365
winter$shift_week <- winter$shift_week%%52


## So if we remove the season 2015-2016 (because of not data in begging 2016) we can
## consider 2012-2013 = 2012 season, 2013-2014 = 2013 season, 2014-2015 = 2014 season 
winter$fake_year <- NA
winter$fake_year[which(winter$season=="2012-2013")] <- "2013"
winter$fake_year[which(winter$season=="2013-2014")] <- "2014"
winter$fake_year[which(winter$season=="2014-2015")] <- "2015"
winter <- winter %>% filter(!is.na(fake_year)) %>% ungroup()
winter <- select(winter, year=fake_year, species, site, yweek=shift_week, cpue)

```

2012 = only species which recruit in summer
2013 = winter species (season 2012-2013) + summer species of 2013
2014 = winter species (season 2013-2014) + summer species of 2014
2015 = winter species (season 2015-2016) + summer species of 2015

```{r}
#----------------
## Summer species 
summer <- dd[-which(dd$species=="Sarpa salpa"),] 
summer <- dd[-which(dd$species=="Pagellus acarne"),]
#summer <- dd[-which(dd$species=="Pagellus bogaraveo"),]
summer <- select(summer, year, species, site, yweek,cpue)

#---------

#Paste Summer and winter species in a same data.frame
samples <- rbind(as.data.frame(summer), as.data.frame(winter))

#Compute the mean arrival week by species/sites/year
ref_detailed <- samples %>% group_by(species,site,year) %>% summarise(ref_week_det=round(weighted.mean(yweek, cpue),0))
ref_sp <- ref_detailed %>% group_by(species) %>% summarise(ref_week_sp = round(mean(ref_week_det),0))


#Join the two data.frame to comute lag time for each site
lag <- left_join(ref_detailed, ref_sp, by=c("species"))
lag$lag_week <- lag$ref_week_det - lag$ref_week_sp

```

```{r fig.height=7}
ggplot(lag) +
  geom_histogram(aes(x=lag_week),binwidth=1) +
  geom_density(aes(x=lag_week, y=..count..)) +
  facet_wrap(~site, ncol=3)+geom_vline(xintercept = 0,linetype="dashed") + xlab("")
```

Test if arrival anomaly (unit of lag_time = week) of each site is relevant with one sample wilcox.test. 

```{r}
descriptive_stats <- lag %>%
  group_by(site) %>%
  summarise(stats=str_c(round(mean(lag_week),2), "±", round(sd(lag_week),1)), median=median(lag_week))

suppressWarnings(test <- lag %>% group_by(site) %>% do(glance(wilcox.test(.$lag_week,mu = 0,alternative = "two.sided"))))

# make a nice table with both
left_join(descriptive_stats, select(test, statistic, p.value), by="site") %>% ungroup()
```

## Synchonicity among years 

Time arrival per year 

```{r}
ggplot(lag) +
  geom_histogram(aes(x=lag_week),binwidth=1) +
  geom_density(aes(x=lag_week, y=..count..)) +
  facet_wrap(~year, ncol=3)+geom_vline(xintercept = 0,linetype="dashed") + xlab("")
```

```{r}
#Compute mean and median lag 
descriptive_stats <- lag %>%
  group_by(year) %>%
  summarise(stats=str_c(round(mean(lag_week),2), "±", round(sd(lag_week),1)), median=median(lag_week)) 

suppressWarnings (test <- lag %>% group_by(year) %>% do(glance(wilcox.test(.$lag_week,mu = 0,alternative = "two.sided"))))

# make a nice table with both
left_join(descriptive_stats, select(test, statistic, p.value), by="year") %>% ungroup()
```


2012 = only species which recruit in summer
2013 = winter species (season 2012-2013) + summer species of 2013
2014 = winter species (season 2013-2014) + summer species of 2014
2015 = winter species (season 2015-2016) + summer species of 2015



