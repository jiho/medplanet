```{r load, message=FALSE, echo=FALSE}
# set knitr options
source("lib_knitr.R")

# load data
load("data.rda")

# load packages and functions
library("plyr")
library("dplyr")
library("tidyverse")
library("FactoMineR")
library("printr")
library("stringr")
library("lubridate")
library("vegan")
library("reshape")
library("ggdendro")

source("lib_plot.R")        # colour scales and theme
source("lib_data_manip.R")  # summarise tables
source("lib_factorial.R")   # extract and plot info from CAs
```

# Spatial distribution

## Abundances among sites

Grouping all taxa, the catch per night is highly variable among sites, with some very extreme events yielding very high catches (NB: q25 and q75 are the quantiles at 25% and 75%, the median is the quantile at 50%; those are less sensitive than the mean to extreme values and represent the "general case" better).

```{r}
dd <- d0 %>% group_by(site, date) %>% summarise(cpue=sum(cpue))

# ggplot(dd) + geom_path(aes(x=cpue, linetype=site, color=site, y=..scaled..), stat="density", bw=0.2) + theme(legend.position=c(0.8, 0.8), legend.key.width=unit(10, "mm")) + labs(y="Scaled probability density")
# last_plot() + scale_x_continuous(trans="identity", limits=c(0,10))

dd %>% sum_tbl("cpue") %>% select(-n, -n_NA)
```
```{r}
ggplot(dd) + geom_boxplot(aes(x=site, y=cpue)) + coord_flip()
```

```{r}
# compute median CPUE per site
cpue_per_site <- dd %>% group_by(site) %>% summarise(med=median(cpue)) %>% arrange(desc(med))
overall_med_cpue <- median(dd$cpue)
cpue_per_site$good <- cpue_per_site$med > overall_med_cpue
```

Excluding those extreme events and focusing on the more common, low, catches, allows to highlight that some sites yield better catches (`r head(cpue_per_site$site, 4)`) and other are consistently low (`r tail(cpue_per_site$site, 4)`). There does not seem to be a large scale geographical pattern to this (sites are ordered from West to East).

```{r fig.height=4}
ggplot(dd) + geom_boxplot(aes(x=site, y=cpue, fill=..middle..), na.rm=T) + coord_flip(ylim=c(0, 10)) + scale_fill_viridis(name="median\ncpue") + theme(legend.position="bottom")
```

TODO test significant diff between all couples of sites, East and West sites, continent vs corsica. kruskal.test, pairwise.wilcox.test

TODO try to cluster some spatial structure. how???



## Species composition among sites


Total number of family, genus and species catched by sampling site.

```{r fig.height=5}
dd_tax <- unique(select(d, site, family, genus, species))
dd_tax <- dd_tax[-which(dd_tax$family=="Unidentified"),]

dd_sp <- ddply(dd_tax, ~ site, summarise, nb.family = length(unique(na.omit(family))),
                          nb.genus = length(unique(na.omit(genus))),
                          nb.species = length(unique(na.omit(species))))

dd_sp <- arrange(dd_sp, nb.species)
dd_sp
```

Through a Correspondence Analysis we can study the *relative* proportions of the dominant species at each site. On the plot, sites are close to the species which were most common at this site compared to other species and other sites. So overall, the following sites are characterised by a larger proportion of the following species:

- Marseille and Villefranche: *O melanuara*, *B boops*, *D annularis*
- Bonifacio and Saint Florent: *S smaris*, *A hepsetus*
- Port-Cros, Agde, and Port-Vendres: *M surmuletus*, *P pilicornis*

For the other sites, no species is particularly characteristic.

```{r fig.height=5}
dd <- d0 %>% filter(species %in% common_species) %>% group_by(site, species) %>% summarise(mean=mean(cpue))
ca <- CA(as.multivar(dd, "site"), graph=F)
autoplot(ca, size=1)
```

```{r fig.height=5}
## CAH clustering for sites based on species abundance
dd <- vegdist(as.multivar(dd, "site"), "bray")
hdw<-hclust(dd,method="ward.D")
plot(hdw, hang=-1)
# dend <- dendro_data(hdw, type = "rectangle")
# ggplot()+ 
#   geom_segment(data=segment(dend),aes(x = x, y = y, xend = xend, yend = yend)) + 
#   geom_text(data=label(dend), aes(x=x, y=y, label=label, hjust=1, angle=25), size=3)+
#   theme(axis.line.x=element_blank(),axis.ticks.x=element_blank(),axis.text.x=element_blank())+
#   ylab("Ultrametric distance")
```

```{r}
# ggplot(dd) + geom_bar(aes(x=species, y=cpue), stat="identity") + facet_grid(site~., scale="free_y") + theme(axis.text.x=element_text(angle=20, hjust=1))

## PERMANOVA
dd <- d0 %>% filter(species %in% common_species) %>% group_by(site, species) %>% summarise(mean=mean(cpue))
data <- cast(dd, site~species)
data.env <- left_join(data, sites, by=c("site"))
data.env <- select(data.env, site, topography, region)
data <- as.multivar(dd, "site")

adonis(data~region, data.env, permutations = 999, method="bray")
adonis(data~topography, data.env, permutations = 999, method="bray")
```

## Most frequent species and genera
```{r}
#Most frequent species (>7sites)
sp_com <- filter(d0, cpue!=0)
sp_com <- select(sp_com, species, site)
sp_com <- unique(sp_com)
sp_com <- sp_com %>% group_by(species)%>% summarise(nb_site=length(site))
sp_com <- arrange(sp_com, desc(nb_site))
sp_com <- na.omit(sp_com)
sp_com <- sp_com %>% head(18) # species observed in >= 7 sites
freq_species <- as.character(sp_com$species)
sort(freq_species)
```

```{r}
#Most frequent genera (>7sites)
gen_com <- filter(d0, cpue!=0)
gen_com <- select(gen_com, genus, site)
gen_com <- unique(gen_com)
gen_com <- gen_com %>% group_by(genus)%>% summarise(nb_site=length(site))
gen_com <- arrange(gen_com, desc(nb_site))
gen_com <- na.omit(gen_com)
gen_com <- gen_com %>% head(18) 
freq_gen <- as.character(gen_com$genus)
sort(freq_gen)
```
TODO do the same with genera

TODO interpret in terms of spatial structure among sites (i.e. compare position of sites on CA)

## Influence of local site variables

```{r}
dd <- d0 %>% filter(!is.na(species)) %>% group_by(date, site, family, species) %>% summarise(cpue=sum(cpue))
dd_stat <- dd %>% group_by(family, species) %>% summarise(mean=mean(cpue), median=median(cpue)) %>% ungroup() %>% arrange(desc(mean))
dd_stat <- dd_stat %>% head(12)
common_species <- dd_stat$species

dd_test <- select(d0, site, species, cpue)
dd_test <- dd_test %>% filter(!is.na(species))
head_sp <- select(dd_stat, family, species)

dd_test <- left_join(head_sp, dd_test, by="species")

#informations of sites
dd_test <- left_join(dd_test, sites, by=c("site"))


# Barplot of mean cpue
dd_region <- dd_test %>% group_by(region, species) %>% summarise(mean = mean(cpue), sd=sd(cpue))
ggplot(dd_region, aes(x = species, y = mean))+ geom_errorbar(aes(ymin=mean, ymax=mean+sd), width=0.2)+geom_bar(stat='identity') + facet_grid(~region) +theme(axis.text.x=element_text(angle=25, hjust=1))+ylim(0,6)

dd_topography <- dd_test %>% group_by(topography, species) %>% summarise(mean = mean(cpue), sd=sd(cpue))
ggplot(dd_topography, aes(x = species, y = mean))+ geom_errorbar(aes(ymin=mean, ymax=mean+sd), width=0.2)+geom_bar(stat='identity') + facet_grid(~topography) +theme(axis.text.x=element_text(angle=25, hjust=1))+ylim(0,6)


#Test differences between region but only three site in east rhone ...
# All species included
res <- dd_test %>% group_by(species, region) %>% summarise(mean =mean(cpue), sd=sd(cpue))
dd_test$region<-as.factor(dd_test$region)
test <- dd_test %>% group_by(species) %>% do(tidy(kruskal.test(.$cpue ~ .$region, data=dd_test)))
test <- as.data.frame(select(test, species, p.value))
test

#Test differences between topography 
#All species included
res <- dd_test %>% group_by(species, topography) %>% summarise(mean =mean(cpue), sd=sd(cpue))
dd_test$topography<-as.factor(dd_test$topography)
test <- dd_test %>% group_by(species) %>% do(tidy(kruskal.test(.$cpue ~ .$topography, data=dd_test)))
test <- as.data.frame(select(test, species, p.value))
test


```


TODO substrate, geomorphology, latitude, depth, etc.


## Synchronicity among sites

```{r fig.height=8}
# mean CPUE per week, site, and species for common species
dd <- d0 %>% filter(year !=2016, species %in% common_species) %>% group_by(yweek, year, site, species) %>% summarise(cpue=mean(cpue))

# create a new weekly date coordinate
dd$date <- ymd(str_c(dd$year, "-01-01")) + weeks(dd$yweek)
# and a new fake one starting all the same year
dd$fake_date <- ymd("2014-01-01") + weeks(dd$yweek)

# rescale abundances per species, site and year, to get a comparable peak per year
dd <- dd %>% group_by(species, site, year) %>% mutate(scaled_cpue=cpue/max(cpue))
dd$scaled_cpue[is.na(dd$scaled_cpue)] <- 0  # when max = 0

# # remove large date jumps (i.e. add NAs at the beginning of the jump)
# dd <- arrange(dd, species, site, date) %>% ungroup()
# dd <- ddply(dd, ~species+site, function(x, large=30) {
#   large_jumps <- c(diff(x$date) > large, FALSE)
#   # repeat each line at the beginning of a large jump
#   x <- x[rep(1:nrow(x), as.numeric(large_jumps)+1),]
#   # replace the abundances at that date by NA
#   large_jumps <- c(diff(x$date) > large, FALSE)
#   x$scaled_cpue[large_jumps] <- NA
#   return(x)
# })

# rename species for display
dd$species_abbr <- abbrev_sp(dd$species, n=4)

# group sites per region
sites$region <- c(
  rep("Golfe du Lion", 3),
  rep("Marseille et environs", 4),
  rep("Var", 2),
  rep("Alpes Mar.", 1),
  rep("Corse", 3)
)

# we want to use a combination of colour and linetype to identify all sites
# ggplot2 cannot do that on its own so we need to manually compute the interaction between the two and create the appropriate scales

# prepare manual colours
colours <- scales::hue_pal(h = c(0, 360) + 15, c = 100, l = 65, h.start = 0)(length(unique(sites$region)))
sites$region_id <- as.numeric(as.factor(sites$region))
sites$colours <- colours[sites$region_id]

# prepare manual linetypes
linetypes <- c("solid", "11", "12", "21")
# linetypes <- 1:4
sites$region_change <- c(FALSE, diff(sites$region_id) != 0)
sites$linetypes <- 0
index <- 0
for (i in 1:nrow(sites)) {
  if (sites$region_change[i]) {
    index <- 1
  } else {
    index <- index + 1
  }
  sites$linetypes[i] <- index
}
sites$linetypes <- linetypes[sites$linetypes]

# compute the interaction, which will be mapped in ggplot
dd <- left_join(dd, select(sites, site, region), by="site")
dd$region_site <- interaction(dd$region, dd$site)
dd$region_site <- factor(dd$region_site, labels=sites$site)

# nice plot
ggplot(dd) +
  geom_line(aes(x=fake_date, y=scaled_cpue, colour=region_site, linetype=region_site)) +
  facet_grid(species_abbr~year)+
  scale_x_date("", date_breaks="2 month", date_labels="%b", minor_breaks=NULL) +
  theme(
    axis.text.x=element_text(angle=45, hjust=1),
    legend.position="top"
  ) +
  scale_linetype_manual("site", values=sites$linetypes) +
  scale_colour_manual("site", values=sites$colours) +
  no_y
```

TODO to interpret

TODO plot, for each site and each species, the anomaly with respect to the mean arrival time of the year

## Synchronicity secund part

```{r}
# mean CPUE per week, site, and species for common species
dd <- d0 %>% filter(year !=2016, species %in% common_species) %>% group_by(yweek, year, site, species) %>% summarise(cpue=mean(cpue))

# create a new weekly date coordinate
dd$date <- ymd(str_c(dd$year, "-01-01")) + weeks(dd$yweek)
# and a new fake one starting all the same year
dd$fake_date <- ymd("2014-01-01") + weeks(dd$yweek)

# rescale abundances per species, site and year, to get a comparable peak per year
dd <- dd %>% group_by(species, site, year) %>% mutate(scaled_cpue=cpue/max(cpue))
dd$scaled_cpue[is.na(dd$scaled_cpue)] <- 0  # when max = 0

# rename species for display
dd$species_abbr <- abbrev_sp(dd$species, n=4)

#Compute mean date and week of recruitment for each species per site and year
syn <- dd %>% group_by(year, site, species) %>% summarise(cpue = max(cpue)) %>% ungroup()
syn <- filter(syn, cpue !=0) # we focus on high values to find date of recruitment
syn <- inner_join(syn, dd, by = c("year", "site", "species","cpue"))
syn <- syn %>% group_by(year, site, species) %>% summarise(cpue = mean(cpue), date = mean(date), yweek=mean(yweek)) %>% ungroup() # mean because some species have twice the same max abundance

syn_year_site <- syn %>% group_by(site, species) %>% summarise(ref_date = mean(date), ref_yweek=mean(yweek))%>%ungroup() # ref all years includes
syn_site <- syn %>% group_by(year, species) %>% summarise(ref_date = mean(date), ref_yweek=mean(yweek))%>%ungroup() # ref all sites includes
syn_year <- syn %>% group_by(species) %>% summarise(ref_date = mean(date), ref_yweek=mean(yweek)) %>% ungroup() # ref all sites and year includes

# Time lag between site, for each year and each species
lag <- left_join(syn_site,syn, by = c("year","species"))
lag <- lag %>% group_by(species,year,site, ref_date, ref_yweek, date, yweek) %>% summarise(lag_day = date-ref_date, lag_week = round(yweek-ref_yweek))%>%ungroup()
lag <- lag %>% arrange(species,year, lag_week)


# Plot and mean lag
lag <- lag[-which(lag$species=="Boops boops"),]
lag <- lag[-which(lag$species=="Oblada melanura"),]
res_site <- lag %>% group_by(site) %>% summarise(mean = mean(lag_week))
```

Anomaly for sites 
```{r fig.height=7}
ggplot(lag) +
  geom_histogram(aes(x=lag_week),binwidth=1) +
  facet_wrap(~site, ncol=3)+geom_vline(xintercept = 0,linetype="dashed") #+ geom_density(aes(x=lag_week))
```

```{r}

# Time lag between site, all years include
lag <- left_join(syn_year_site,syn_year, by = c("species"))
lag <- select(lag, species, site, date = ref_date.x, yweek = ref_yweek.x, ref_date = ref_date.y, ref_yweek = ref_yweek.y)
lag <- lag %>% group_by(species,site, ref_date, ref_yweek, date, yweek) %>% summarise(lag_week = round(yweek-ref_yweek,0))%>%ungroup()
lag <- lag %>% arrange(species,lag_week)



# Time lag between year, for each species
lag <- left_join(syn_site,syn_year, by = c("species"))
lag <- select(lag, species, year, date = ref_date.x, yweek = ref_yweek.x, ref_date = ref_date.y, ref_yweek = ref_yweek.y)
lag <- lag %>% group_by(species, year, ref_date, ref_yweek,date, yweek) %>% summarise(lag_week = round(yweek-ref_yweek,0)) %>% ungroup()
lag <- lag %>% arrange(species, lag_week)



# Plot and mean lag
lag <- lag[-which(lag$species=="Boops boops"),]
lag <- lag[-which(lag$species=="Oblada melanura"),]
res <- lag %>% group_by(year) %>% summarise(mean = mean(lag_week))

```

Anomaly for year 
```{r fig.height=4}
ggplot(lag) +
  geom_histogram(aes(x=lag_week),binwidth=1) +
  facet_wrap(~year, ncol=3)+geom_vline(xintercept = 0,linetype="dashed") #+ geom_density(aes(x=lag_week))
```
