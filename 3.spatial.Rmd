```{r load, message=FALSE, echo=FALSE}
# set knitr options
source("lib_knitr.R")

# load data
load("data.rda")

# load packages and functions
library("plyr")
library("tidyverse")
library("FactoMineR")
library("printr")
library("stringr")
library("lubridate")

source("lib_plot.R")        # colour scales and theme
source("lib_data_manip.R")  # summarise tables
source("lib_factorial.R")   # extract and plot info from CAs
```

# Spatial distribution

## Abundances among sites

Grouping all taxa, the catch per night is highly variable among sites, with some very extreme events yielding very high catches (NB: q25 and q75 are the quantiles at 25% and 75%, the median is the quantile at 50%; those are less sensitive than the mean to extreme values and represent the "general case" better).

```{r}
dd <- d0 %>% group_by(site, date) %>% summarise(cpue=sum(cpue))

# ggplot(dd) + geom_path(aes(x=cpue, linetype=site, color=site, y=..scaled..), stat="density", bw=0.2) + theme(legend.position=c(0.8, 0.8), legend.key.width=unit(10, "mm")) + labs(y="Scaled probability density")
# last_plot() + scale_x_continuous(trans="identity", limits=c(0,10))

dd %>% sum_tbl("cpue") %>% select(-n, -n_NA)
```
```{r}
ggplot(dd) + geom_boxplot(aes(x=site, y=cpue)) + coord_flip()
```

```{r}
# compute median CPUE per site
cpue_per_site <- dd %>% group_by(site) %>% summarise(med=median(cpue)) %>% arrange(desc(med))
overall_med_cpue <- median(dd$cpue)
cpue_per_site$good <- cpue_per_site$med > overall_med_cpue
```

Excluding those extreme events and focusing on the more common, low, catches, allows to highlight that some sites yield better catches (`r head(cpue_per_site$site, 4)`) and other are consistently low (`r tail(cpue_per_site$site, 4)`). There does not seem to be a large scale geographical pattern to this (sites are ordered from West to East).

```{r fig.height=4}
ggplot(dd) + geom_boxplot(aes(x=site, y=cpue, fill=..middle..), na.rm=T) + coord_flip(ylim=c(0, 10)) + scale_fill_viridis(name="median\ncpue") + theme(legend.position="bottom")
```

## Species composition among sites

Through a Correspondence Analysis we can study the *relative* proportions of the dominant species at each site. On the plot, sites are close to the species which were most common at this site compared to other species and other sites. So overall, the following sites are characterised by a larger proportion of the following species:

- Marseille and Villefranche: *O melanuara*, *B boops*, *D annularis*
- Bonifacio and Saint Florent: *S smaris*, *A hepsetus*
- Port-Cros, Agde, and Port-Vendres: *M surmuletus*, *P pilicornis*

For the other sites, no species is particularly characteristic.

```{r fig.height=5}
dd <- d0 %>% filter(species %in% common_species) %>% group_by(site, species) %>% summarise(mean=mean(cpue))
ca <- CA(as.multivar(dd, "site"), graph=F)
autoplot(ca, size=1)

# ggplot(dd) + geom_bar(aes(x=species, y=cpue), stat="identity") + facet_grid(site~., scale="free_y") + theme(axis.text.x=element_text(angle=20, hjust=1))
```

## Influence of local site variables

TODO substrate, geomorphology, latitude, depth, etc.

## Synchronicity among sites

```{r warning=FALSE}

# species
dd <- d0 %>% filter(!is.na(species)) %>% group_by(date, site, family, species) %>% summarise(cpue=sum(cpue))
dd_stat <- dd %>% group_by(family, species) %>% summarise(mean=mean(cpue), median=median(cpue)) %>% ungroup() %>% arrange(desc(mean))
dd_stat <- dd_stat %>% head(12)
common_species <- dd_stat$species
dd$species <- factor(dd$species, levels=dd_stat$species)

# Synchronicity betwenn regions

dd <- d0 %>% filter(year != 2016, species %in% common_species) %>% group_by(yweek, year, site, species) %>% summarise(cpue=mean(cpue))

# create a fake date coordinate
dd$fake_date <- ymd("2014-01-01") + weeks(dd$yweek)

# rescale per species, year and sites
dd <- dd %>% group_by(species, site) %>% mutate(scaled_cpue=cpue/max(cpue))
dd$scaled_cpue[is.na(dd$scaled_cpue)] <- 0  # when max = 0


# order species by average/first date of arrival
order <- dd %>%
  group_by(species) %>%
  filter(cpue > median(cpue)) %>%
  summarise(avg_date=weighted.mean(yweek, scaled_cpue), first_date=min(yweek)) %>%
  arrange(first_date)

# rename species for display
abbrev_sp <- function(x, n=4) {
  bits <- str_split_fixed(x, fixed(" "), 2)
  g <- str_sub(bits[,1],1,1)
  s <- str_sub(bits[,2],1,n)
  str_c(g, ". ", s)
}
order$species_abbr <- abbrev_sp(order$species, n=5)

# force order by time of arrival
dd$species_abbr <- factor(dd$species, levels=order$species, labels=order$species_abbr)

ggplot(dd) +
  geom_path(aes(x=fake_date, y=scaled_cpue, colour=site)) +
  facet_grid(species_abbr~year)+
  scale_x_date(date_breaks="1 month", date_labels="%b", minor_breaks=NULL) +
  scale_color_manual(values=c("Leucate"="#339900", "Port Vendres"="#339900",
                                     "Agde"="#339900","Carry"="#0066CC",
                                     "Marseille"="#0066CC", "Cassis"="#0066CC",
                                     "La Ciotat"="#0066CC","Les Embiez"="#CCCC33",
                                     "Port-Cros"="#CCCC33", "Villefranche"="#9900CC",
                                     "Bastia"="#CC0000", "Bonifacio"="#CC0000", "Saint Florent"="#CC0000"),
                     breaks=c("Leucate","Port Vendres","Agde",
                              "Carry","Marseille", "Cassis","La Ciotat",
                              "Les Embiez","Port-Cros","Villefranche","Bastia","Bonifacio",
                              "Saint Florent")) +
labs(y="cpue (scaled per species and site)") + no_y



#Cross correlation

#Example
coef <- ccf(dd$scaled_cpue[which(dd$site=="Villefranche"|dd$year=="2013")],dd$scaled_cpue[which(dd$site=="Agde"|dd$year=="2013")],lag.max=20)
cor = coef$acf[,,1]
cor
lag = coef$lag[,,1]
lag
res = data.frame(cor,lag)
res
res_max = res[which.max(res$cor),]
res_max


#For all possibilities :  doesn't work 

find_max_ccf <- ddply(dd,~site+year, function(a,b){
  coeff <- ccf(a$scaled_cpue, b$scaled_cpue, lag.max=20)
  cor = p$acf[,,1]
  lag = p$lag[,,1]
  res = data.frame(cor,lag)
  res_max = res[which.max(res$cor),]
  return(res_max)
}
)
```
